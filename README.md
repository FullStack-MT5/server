# server

This repository holds the code for the main Benchttp server which offers a RESTful API.

It is deployed independently from the other parts making our system.

## API

### Push report of a run

```txt
POST /v1/reports
```

#### Parameters

| Name     | Type                   | In   | Description                                   |
| -------- | ---------------------- | ---- | --------------------------------------------- |
| `report` | bytes (`gob` encoding) | body | The raw report data generated by the `runner` |

#### Response

```txt
Status: 201 Created
```

### Get the report of a particular run

```txt
GET /v1/reports/{id}
```

#### Parameters

| Name | Type   | In   | Description             |
| ---- | ------ | ---- | ----------------------- |
| `id` | string | path | The requested report ID |

#### Response

```txt
Status: 200 OK
```

<details>
  <summary>JSON response</summary>

```json
{
  "benchmark": {
    "records": [
      {
        "time": 152970821,
        "code": 200,
        "bytes": 46,
        "error": "",
        "events": [
          {
            "name": "GotFirstResponseByte",
            "time": 2457696
          }
          // ...
        ]
      }
      // ...
    ],
    "length": 10,
    "success": 10,
    "fail": 0,
    "duration": 324953628
  },
  "metadata": {
    "config": {
      "request": {
        "method": "GET",
        "url": {
          "scheme": "http",
          "opaque": "",
          "user": null,
          "host": "echo.jsontest.com",
          "path": "/title/ipsum/content/blah",
          "rawPath": "",
          "forceQuery": false,
          "rawQuery": "",
          "fragment": "",
          "rawFragment": ""
        },
        "header": {},
        "body": {
          "type": "",
          "content": ""
        }
      },
      "runner": {
        "requests": 10,
        "concurrency": 10,
        "interval": 50000000,
        "requestTimeout": 2000000000,
        "globalTimeout": 30000000000
      }
    },
    "finishedAt": "2022-02-27T19:54:19.019717Z"
  }
}
```

</details>

## Deployment

The infrastructure code defining the deployment of `server` is located inside [benchttp/infra](https://github.com/benchttp/infra).

## Development

### Lint

Run the linter:

> We use [golangci-lint](https://golangci-lint.run/) in our CI.

```sh
make lint
# alias to:
# golangci-lint run
```

### Test

Run all tests:

```sh
make test
# alias to:
# go test -v -timeout 30s ./...
```

Run a specific test passing `t` to specify a test and `p` to specify a package (parameters are independent):

```sh
make test t=TestCompute p=pkg/golastic
# alias to:
# go test -v -timeout 30s -run TestCompute ./stats
```
